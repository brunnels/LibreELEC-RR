From 91ef508b3ec28869b894910a456e2b1f6a10e8c7 Mon Sep 17 00:00:00 2001
From: 5schatten <supervisedthinking@gmail.com>
Date: Mon, 9 Sep 2019 19:29:07 +0200
Subject: [PATCH] bsnes/libretro: conditionally disable OpenMP

---
 bsnes/target-libretro/GNUmakefile | 10 +++++++---
 1 file changed, 7 insertions(+), 3 deletions(-)

diff --git a/bsnes/target-libretro/GNUmakefile b/bsnes/target-libretro/GNUmakefile
index 57e5f982..4d0ac043 100644
--- a/bsnes/target-libretro/GNUmakefile
+++ b/bsnes/target-libretro/GNUmakefile
@@ -1,8 +1,12 @@
 name := libretro.so
 flags += -Wno-narrowing -Wno-multichar -g -fPIC
 
-ifneq ($(platform),macos)
-	flags += -fopenmp
+# OpenMP support
+ifeq ($(openmp),true)
+  ifneq ($(platform),macos)
+    flags   += -fopenmp
+    LDFLAGS += -lgomp
+  endif
 endif
 
 objects := libretro $(objects)
@@ -12,7 +16,7 @@ obj/libretro.o: target-libretro/libretro.cpp
 
 all: $(objects)
 ifeq ($(platform),linux)
-	$(strip $(compiler) -o out/bsnes_hd_libretro.so -shared $(objects) -Wl,--no-undefined -Wl,--version-script=target-libretro/link.T -Wl,-Bdynamic -lpthread -ldl -lgomp)
+	$(strip $(compiler) -o out/bsnes_hd_libretro.so -shared $(objects) -Wl,--no-undefined -Wl,--version-script=target-libretro/link.T -Wl,-Bdynamic -lpthread -ldl $(LDFLAGS))
 else ifeq ($(platform),windows)
 	$(strip $(compiler) -o out/bsnes_hd_libretro.dll -shared $(objects) -Wl,--no-undefined -Wl,--version-script=target-libretro/link.T -static-libgcc -static-libstdc++ -Wl,-Bstatic -lws2_32 -lpthread -lgomp -Wl,-Bdynamic)
 else ifeq ($(platform),macos)
