#!/bin/sh
# SPDX-License-Identifier: GPL-2.0-or-later
# Copyright (C) Originally created by Escalade (https://github.com/escalade)
# Copyright (C) 2018-present 5schatten (https://github.com/5schatten)

. /etc/profile

ICON=/usr/config/spotify/icon.png
SPOTIFY_HOME=/storage/.cache/app.spotify
SPOTIFY_VERSION=$SPOTIFY_HOME/spotify.version
SPOTIFY_PKGVER=`curl -s "https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=spotify" | grep -E '^pkgver=' | cut -c8-17`

install_spotify() {
  kodi-send --action="Notification(Spotify,This is the first time you are starting Spotify. It is being downloaded in the background,13000,${ICON})"
  if [ -z "$1" ]; then
    export `curl -s "https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=spotify" | grep -E '^pkgver='` || exit 1
    export `curl -s "https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=spotify" | grep -E '^_anotherpkgver='` || exit 1
    export `curl -s "https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=spotify" | grep -E '^source_x86_64='` || exit 1
    export `curl -s "https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=spotify" | grep -E '^_amd64_pkgrel='`
    export url=`echo $source_x86_64 | sed s:\$\{pkgver\}:$pkgver: | sed s:\$\{_anotherpkgver\}:$_anotherpkgver: | sed s:\$\{_amd64_pkgrel\}:$_amd64_pkgrel: | cut -d \" -f 2`
  else
    export url="$1"
  fi 
  mkdir -p /tmp/spotify ; cd /tmp/spotify
  wget -q $url || exit 1
  kodi-send --action="Notification(Spotify,Download finished. Installing Spotify.,8000,${ICON})"
  ar -x *.deb && tar -zxf data.tar.gz
  mv usr/share/spotify $SPOTIFY_HOME
  echo $SPOTIFY_PKGVER > $SPOTIFY_VERSION 2>&1
  cd ~ ; rm -rf /tmp/spotify
}

update_spotify() {
  kodi-send --action="Notification(Spotify,Updating Spotify. It is being downloaded in the background.,8000,${ICON})"
  if [ -z "$1" ]; then
    export `curl -s "https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=spotify" | grep -E '^pkgver='` || exit 1
    export `curl -s "https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=spotify" | grep -E '^_anotherpkgver='` || exit 1
    export `curl -s "https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=spotify" | grep -E '^source_x86_64='` || exit 1
    export `curl -s "https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=spotify" | grep -E '^_amd64_pkgrel='`
    export url=`echo $source_x86_64 | sed s:\$\{pkgver\}:$pkgver: | sed s:\$\{_anotherpkgver\}:$_anotherpkgver: | sed s:\$\{_amd64_pkgrel\}:$_amd64_pkgrel: | cut -d \" -f 2`
  else
    export url="$1"
  fi 
  mkdir -p /tmp/spotify ; cd /tmp/spotify
  wget -q $url || exit 1
  kodi-send --action="Notification(Spotify,Download finished. Updating Spotify.,8000,${ICON})"
  ar -x *.deb && tar -zxf data.tar.gz
  rm -rf $SPOTIFY_HOME
  mv usr/share/spotify $SPOTIFY_HOME
  echo $SPOTIFY_PKGVER > $SPOTIFY_VERSION 2>&1
  cd ~ ; rm -rf /tmp/spotify
}

run_spotify() {
  kodifreeze.sh freeze
  systemctl stop pulseaudio
  $SPOTIFY_HOME/spotify "$@"
  systemctl start pulseaudio
  kodifreeze.sh unfreeze
}

if [ ! -x $SPOTIFY_HOME ]; then
  install_spotify "$1" > /var/log/spotify-install.log 2>&1
fi

if [ "$SPOTIFY_PKGVER" != "$(cat $SPOTIFY_VERSION)" ]; then
  update_spotify "$1" > /var/log/spotify-install.log 2>&1
fi

run_spotify "$@" > /var/log/spotify.log 2>&1
