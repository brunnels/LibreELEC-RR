# Set ALSA output device
set_ALSA_output_device() {
  # Set common vars
  ASOUND_CONF=/storage/.config/asound.conf
  ASOUND_CONF_SAMPLE=/storage/.config/asound.conf.sample
  KODI_GUISETTINGS=/storage/.kodi/userdata/guisettings.xml
  KODI_SOUND_OUTPUT_DEVICE=$(cat ${KODI_GUISETTINGS} | grep audiooutput.audiodevice | cut -f2- -d":" | cut -f1 -d"<")

  if [ ! -f ${ASOUND_CONF} ];then
    cp ${ASOUND_CONF_SAMPLE} ${ASOUND_CONF}
  fi
  
  if [ -n ${KODI_SOUND_OUTPUT_DEVICE} ];then
    sed -i -e "s/default \".*/default \"${KODI_SOUND_OUTPUT_DEVICE}\"/" ${ASOUND_CONF}
  fi
}

# force SDL2 audio engine
set_CITRA_audioengine() {
  CITRA_HOME_CONFIG=/storage/.config/citra-emu
  CITRA_QTCONFIG=$CITRA_HOME_CONFIG/qt-config.ini

  sed -i -e "s/output_engine=.*/output_engine=sdl2/" $CITRA_QTCONFIG
  sed -i -e "s/output_engine\\\default=.*/output_engine\\\default=false/" $CITRA_QTCONFIG
}

# Set audio backend to PulseAudio or ALSA
set_DOLPHIN_audiobackend() {
  DOLPHIN_HOME=/storage/.config/dolphin-emu
  DOLPHIN_CONFIG=$DOLPHIN_HOME/Dolphin.ini

  if [ -f /storage/.config/usePulseAudio ]; then
    sed -i -e "s/Backend = ALSA/Backend = Pulse/" $DOLPHIN_CONFIG
  else
    sed -i -e "s/Backend = Pulse/Backend = ALSA/" $DOLPHIN_CONFIG
  fi
}

# Inform about missing asound.conf
missing_asound_conf() {
  kodi-send --action="Notification(ALSA: missing asound.conf,Please read the FAQ how to configure your asound.conf first. Otherwise you won't get any sound output in apps or emulators.,20500,DefaultIconError.png)"
}

# Set OpenAL audio driver to Pulseaudio or ALSA
set_OpenAL_audiodriver() {
  if [ -f /storage/.alsoftrc ] && [ ! -f /storage/.config/usePulseAudio ]; then  
    rm /storage/.alsoftrc
  else
    if [ -f /storage/.config/usePulseAudio ]; then
      cp /etc/openal/alsoft.conf /storage/.alsoftrc
      sed -i -e "s/drivers=alsa/drivers=pulse/" /storage/.alsoftrc
    fi
  fi
}

# Set audio & midi driver
set_RA_audiodriver() {
  RETROARCH_HOME=/storage/.config/retroarch
  RETROARCH_CONFIG=$RETROARCH_HOME/retroarch.cfg

  if [ -f /storage/.config/usePulseAudio ]; then
    sed -i -e "s/audio_driver = \"alsathread\"/audio_driver = \"pulse\"/" $RETROARCH_CONFIG
    sed -i -e "s/midi_driver = \"null\"/midi_driver = \"alsa\"/" $RETROARCH_CONFIG
    sed -i -e "s/midi_output = \"Off\"/midi_output = \"FluidSynth\"/" $RETROARCH_CONFIG
  else
    sed -i -e "s/audio_driver = \"pulse\"/audio_driver = \"alsathread\"/" $RETROARCH_CONFIG
    sed -i -e "s/midi_driver = \"alsa\"/midi_driver = \"null\"/" $RETROARCH_CONFIG
    sed -i -e "s/midi_output = \"FluidSynth\"/midi_output = \"Off\"/" $RETROARCH_CONFIG
  fi
}

# Set SDL audio driver to Pulseaudio or ALSA
set_SDL_audiodriver() {
  if [ -f /storage/.config/usePulseAudio ]; then
    export SDL_AUDIODRIVER=pulseaudio
  else
    export SDL_AUDIODRIVER=alsa
  fi
}

start_FluidSynth_PA() {
  pactl load-module module-udev-detect tsched=0 &
  systemctl start fluidsynth &
}

stop_FluidSynth_PA() {
  systemctl stop fluidsynth
  pactl unload-module module-udev-detect
  pactl unload-module module-alsa-card
}
